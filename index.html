<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noriks Call Center</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">N</div>
            <span class="sidebar-title">Call Center</span>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="#" class="nav-item active" data-tab="abandoned">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Abandoned Carts</span>
                    <span class="nav-badge" id="abandoned-count">0</span>
                </a>
                <a href="#" class="nav-item" data-tab="suppressed">
                    <i class="fas fa-user-slash"></i>
                    <span>Suppressed Profiles</span>
                    <span class="nav-badge" id="suppressed-count">0</span>
                </a>
                <a href="#" class="nav-item" data-tab="pending">
                    <i class="fas fa-clock"></i>
                    <span>Pending Orders</span>
                    <span class="nav-badge" id="pending-count">0</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Reports</div>
                <a href="report.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistics</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">N</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Noriks</div>
                    <div class="user-role" id="userRole">Admin</div>
                </div>
                <button onclick="logout()" style="background: none; border: none; color: var(--sidebar-text); cursor: pointer; padding: 8px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="breadcrumb">
                    <a href="#">Application</a>
                    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                    <span class="current">Call Center</span>
                </div>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="globalSearch">
                </div>
                <button class="header-btn" onclick="loadData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="header-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge"></span>
                </button>
                <div class="header-avatar" id="headerAvatar">N</div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-content">
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon blue">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="statAbandoned">0</div>
                    <div class="stat-label">Abandoned Carts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon purple">
                            <i class="fas fa-user-slash"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="statSuppressed">0</div>
                    <div class="stat-label">Suppressed Profiles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon orange">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon green">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="statCalled">0</div>
                    <div class="stat-label">Called Today</div>
                </div>
            </div>
            
            <!-- Main Card with Tabs -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-headset"></i>
                        Call Queue
                    </h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="loadData()">
                            <i class="fas fa-sync-alt"></i>
                            Reload Data
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" data-tab="abandoned">
                            <i class="fas fa-shopping-cart"></i>
                            Abandoned Carts
                            <span class="count" id="tab-abandoned-count">0</span>
                        </button>
                        <button class="tab" data-tab="suppressed">
                            <i class="fas fa-user-slash"></i>
                            Suppressed
                            <span class="count" id="tab-suppressed-count">0</span>
                        </button>
                        <button class="tab" data-tab="pending">
                            <i class="fas fa-clock"></i>
                            Pending Orders
                            <span class="count" id="tab-pending-count">0</span>
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <select class="filter-select" id="filterStore">
                            <option value="">All Stores</option>
                        </select>
                        <select class="filter-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="not_called">Not Called</option>
                            <option value="called">Called</option>
                            <option value="answered">Answered</option>
                            <option value="no_answer">No Answer</option>
                            <option value="converted">Converted</option>
                            <option value="not_interested">Not Interested</option>
                        </select>
                        <input type="text" class="filter-input" id="filterSearch" placeholder="Search by name, email, phone...">
                    </div>
                    
                    <!-- Table Content -->
                    <div id="content-abandoned" class="tab-content active">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Store</th>
                                        <th>Cart Value</th>
                                        <th>Items</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="abandoned-table">
                                    <tr>
                                        <td colspan="8">
                                            <div class="loading">
                                                <div class="loading-spinner"></div>
                                                Loading abandoned carts...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="content-suppressed" class="tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Profile</th>
                                        <th>Phone</th>
                                        <th>Reason</th>
                                        <th>Suppressed</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="suppressed-table">
                                    <tr>
                                        <td colspan="7">
                                            <div class="loading">
                                                <div class="loading-spinner"></div>
                                                Loading suppressed profiles...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="content-pending" class="tab-content" style="display: none;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Store</th>
                                        <th>Order</th>
                                        <th>Total</th>
                                        <th>Phone</th>
                                        <th>Order Status</th>
                                        <th>Call Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-table">
                                    <tr>
                                        <td colspan="8">
                                            <div class="loading">
                                                <div class="loading-spinner"></div>
                                                Loading pending orders...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Update Status Modal -->
    <div class="modal-overlay" id="statusModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Update Call Status</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Call Status</label>
                    <select class="form-select" id="modalStatus">
                        <option value="not_called">Not Called</option>
                        <option value="called">Called</option>
                        <option value="answered">Answered</option>
                        <option value="no_answer">No Answer</option>
                        <option value="converted">Converted</option>
                        <option value="not_interested">Not Interested</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="modalNotes" placeholder="Add notes about this call..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveStatus()">
                    <i class="fas fa-check"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let abandonedCarts = [];
        let suppressedProfiles = [];
        let pendingOrders = [];
        let stores = [];
        let currentTab = 'abandoned';
        let currentEditId = null;
        
        // Check auth
        const user = JSON.parse(localStorage.getItem('callcenter_user') || 'null');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Admin' : 'Agent';
            document.getElementById('userAvatar').textContent = user.username[0].toUpperCase();
            document.getElementById('headerAvatar').textContent = user.username[0].toUpperCase();
        }
        
        // Navigation
        document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const tab = item.dataset.tab;
                switchTab(tab);
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
            });
        });
        
        document.querySelectorAll('.tab[data-tab]').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`content-${tab}`).style.display = 'block';
            applyFilters();
        }
        
        // Mobile sidebar
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        });
        
        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        });
        
        // Load data
        async function loadData() {
            await loadStores();
            await Promise.all([
                loadAbandonedCarts(),
                loadSuppressedProfiles(),
                loadPendingOrders()
            ]);
            updateStats();
        }
        
        async function loadStores() {
            try {
                const res = await fetch('api.php?action=stores');
                stores = await res.json();
                const select = document.getElementById('filterStore');
                select.innerHTML = '<option value="">All Stores</option>';
                stores.forEach(s => {
                    select.innerHTML += `<option value="${s.code}">${s.flag} ${s.name}</option>`;
                });
            } catch (e) {
                console.error('Failed to load stores:', e);
            }
        }
        
        async function loadAbandonedCarts() {
            try {
                const res = await fetch('api.php?action=abandoned-carts');
                abandonedCarts = await res.json();
                document.getElementById('abandoned-count').textContent = abandonedCarts.length;
                document.getElementById('tab-abandoned-count').textContent = abandonedCarts.length;
                document.getElementById('statAbandoned').textContent = abandonedCarts.length.toLocaleString();
                renderAbandonedCarts();
            } catch (e) {
                console.error('Failed to load abandoned carts:', e);
            }
        }
        
        async function loadSuppressedProfiles() {
            try {
                const res = await fetch('api.php?action=suppressed-profiles');
                suppressedProfiles = await res.json();
                document.getElementById('suppressed-count').textContent = suppressedProfiles.length;
                document.getElementById('tab-suppressed-count').textContent = suppressedProfiles.length;
                document.getElementById('statSuppressed').textContent = suppressedProfiles.length.toLocaleString();
                renderSuppressedProfiles();
            } catch (e) {
                console.error('Failed to load suppressed profiles:', e);
            }
        }
        
        async function loadPendingOrders() {
            try {
                const res = await fetch('api.php?action=pending-orders');
                pendingOrders = await res.json();
                document.getElementById('pending-count').textContent = pendingOrders.length;
                document.getElementById('tab-pending-count').textContent = pendingOrders.length;
                document.getElementById('statPending').textContent = pendingOrders.length.toLocaleString();
                renderPendingOrders();
            } catch (e) {
                console.error('Failed to load pending orders:', e);
            }
        }
        
        function updateStats() {
            const allItems = [...abandonedCarts, ...suppressedProfiles, ...pendingOrders];
            const calledToday = allItems.filter(i => 
                i.callStatus && i.callStatus !== 'not_called' && 
                i.lastUpdated && new Date(i.lastUpdated).toDateString() === new Date().toDateString()
            ).length;
            document.getElementById('statCalled').textContent = calledToday.toLocaleString();
        }
        
        // Render functions
        function renderAbandonedCarts(data = null) {
            const items = data || abandonedCarts;
            const tbody = document.getElementById('abandoned-table');
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>No abandoned carts</h3></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = items.map(cart => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(cart.customerName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${escapeHtml(cart.customerName)}</div>
                                <div class="customer-email">${escapeHtml(cart.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="store-badge">
                            <span class="store-flag">${cart.storeFlag}</span>
                            ${cart.storeName}
                        </span>
                    </td>
                    <td class="amount-cell">${formatCurrency(cart.cartValue, cart.currency)}</td>
                    <td>
                        <div class="cart-items">
                            ${cart.cartContents.slice(0, 2).map(item => `
                                <div class="cart-item">
                                    <span class="cart-item-qty">${item.quantity}x</span>
                                    ${escapeHtml(item.name.substring(0, 30))}${item.name.length > 30 ? '...' : ''}
                                </div>
                            `).join('')}
                            ${cart.cartContents.length > 2 ? `<div class="cart-item" style="color: var(--text-muted);">+${cart.cartContents.length - 2} more</div>` : ''}
                        </div>
                    </td>
                    <td>
                        ${cart.phone ? `<a href="tel:${cart.phone}" class="phone-link"><i class="fas fa-phone"></i> ${cart.phone}</a>` : '<span style="color: var(--text-muted);">—</span>'}
                    </td>
                    <td><span class="status-badge ${cart.callStatus}">${formatStatus(cart.callStatus)}</span></td>
                    <td>
                        <div class="timestamp">
                            <div class="timestamp-ago">${timeAgo(cart.abandonedAt)}</div>
                            ${formatDate(cart.abandonedAt)}
                        </div>
                    </td>
                    <td>
                        <div class="action-btns">
                            ${cart.phone ? `<button class="action-btn call" onclick="makeCall('${cart.phone}')" title="Call"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${cart.id}', '${cart.callStatus}', '${escapeHtml(cart.notes || '')}')" title="Update Status"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderSuppressedProfiles(data = null) {
            const items = data || suppressedProfiles;
            const tbody = document.getElementById('suppressed-table');
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-user-slash"></i><h3>No suppressed profiles</h3></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = items.map(profile => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(profile.firstName + ' ' + profile.lastName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${escapeHtml(profile.firstName)} ${escapeHtml(profile.lastName)}</div>
                                <div class="customer-email">${escapeHtml(profile.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${profile.phone ? `<a href="tel:${profile.phone}" class="phone-link"><i class="fas fa-phone"></i> ${profile.phone}</a>` : '<span style="color: var(--text-muted);">—</span>'}
                    </td>
                    <td><span class="status-badge" style="background: #fef3c7; color: #92400e;">${formatReason(profile.suppressionReason)}</span></td>
                    <td>
                        <div class="timestamp">
                            <div class="timestamp-ago">${timeAgo(profile.suppressedAt)}</div>
                            ${formatDate(profile.suppressedAt)}
                        </div>
                    </td>
                    <td><span class="status-badge ${profile.callStatus}">${formatStatus(profile.callStatus)}</span></td>
                    <td><div class="notes-preview">${escapeHtml(profile.notes || '')}</div></td>
                    <td>
                        <div class="action-btns">
                            ${profile.phone ? `<button class="action-btn call" onclick="makeCall('${profile.phone}')" title="Call"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${profile.id}', '${profile.callStatus}', '${escapeHtml(profile.notes || '')}')" title="Update Status"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderPendingOrders(data = null) {
            const items = data || pendingOrders;
            const tbody = document.getElementById('pending-table');
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-clock"></i><h3>No pending orders</h3></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = items.map(order => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(order.customerName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${escapeHtml(order.customerName)}</div>
                                <div class="customer-email">${escapeHtml(order.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="store-badge">
                            <span class="store-flag">${order.storeFlag}</span>
                            ${order.storeName}
                        </span>
                    </td>
                    <td><strong>#${order.orderId}</strong></td>
                    <td class="amount-cell">${formatCurrency(order.orderTotal, order.currency)}</td>
                    <td>
                        ${order.phone ? `<a href="tel:${order.phone}" class="phone-link"><i class="fas fa-phone"></i> ${order.phone}</a>` : '<span style="color: var(--text-muted);">—</span>'}
                    </td>
                    <td><span class="status-badge" style="background: #fef3c7; color: #92400e;">${order.orderStatus}</span></td>
                    <td><span class="status-badge ${order.callStatus}">${formatStatus(order.callStatus)}</span></td>
                    <td>
                        <div class="action-btns">
                            ${order.phone ? `<button class="action-btn call" onclick="makeCall('${order.phone}')" title="Call"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${order.id}', '${order.callStatus}', '${escapeHtml(order.notes || '')}')" title="Update Status"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Filters
        document.getElementById('filterStore').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterSearch').addEventListener('input', applyFilters);
        document.getElementById('globalSearch').addEventListener('input', applyFilters);
        
        function applyFilters() {
            const store = document.getElementById('filterStore').value;
            const status = document.getElementById('filterStatus').value;
            const search = (document.getElementById('filterSearch').value || document.getElementById('globalSearch').value).toLowerCase();
            
            if (currentTab === 'abandoned') {
                let filtered = abandonedCarts;
                if (store) filtered = filtered.filter(c => c.storeCode === store);
                if (status) filtered = filtered.filter(c => c.callStatus === status);
                if (search) filtered = filtered.filter(c => 
                    c.customerName.toLowerCase().includes(search) ||
                    c.email.toLowerCase().includes(search) ||
                    (c.phone && c.phone.includes(search))
                );
                renderAbandonedCarts(filtered);
            } else if (currentTab === 'suppressed') {
                let filtered = suppressedProfiles;
                if (status) filtered = filtered.filter(p => p.callStatus === status);
                if (search) filtered = filtered.filter(p => 
                    (p.firstName + ' ' + p.lastName).toLowerCase().includes(search) ||
                    p.email.toLowerCase().includes(search) ||
                    (p.phone && p.phone.includes(search))
                );
                renderSuppressedProfiles(filtered);
            } else if (currentTab === 'pending') {
                let filtered = pendingOrders;
                if (store) filtered = filtered.filter(o => o.storeCode === store);
                if (status) filtered = filtered.filter(o => o.callStatus === status);
                if (search) filtered = filtered.filter(o => 
                    o.customerName.toLowerCase().includes(search) ||
                    o.email.toLowerCase().includes(search) ||
                    (o.phone && o.phone.includes(search)) ||
                    String(o.orderId).includes(search)
                );
                renderPendingOrders(filtered);
            }
        }
        
        // Modal
        function openModal(id, status, notes) {
            currentEditId = id;
            document.getElementById('modalStatus').value = status;
            document.getElementById('modalNotes').value = notes;
            document.getElementById('statusModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('statusModal').classList.remove('active');
            currentEditId = null;
        }
        
        async function saveStatus() {
            if (!currentEditId) return;
            
            const status = document.getElementById('modalStatus').value;
            const notes = document.getElementById('modalNotes').value;
            
            try {
                await fetch('api.php?action=update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentEditId, callStatus: status, notes })
                });
                
                // Update local data
                const updateItem = (arr) => {
                    const item = arr.find(i => i.id === currentEditId);
                    if (item) {
                        item.callStatus = status;
                        item.notes = notes;
                        item.lastUpdated = new Date().toISOString();
                    }
                };
                updateItem(abandonedCarts);
                updateItem(suppressedProfiles);
                updateItem(pendingOrders);
                
                applyFilters();
                updateStats();
                closeModal();
            } catch (e) {
                alert('Failed to save status');
            }
        }
        
        function makeCall(phone) {
            window.open(`tel:${phone}`, '_self');
        }
        
        function logout() {
            localStorage.removeItem('callcenter_user');
            window.location.href = 'login.html';
        }
        
        // Helpers
        function getInitials(name) {
            return (name || '?').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function formatCurrency(amount, currency) {
            const symbols = { EUR: '€', CZK: 'Kč', PLN: 'zł', HUF: 'Ft' };
            return `${symbols[currency] || currency} ${parseFloat(amount || 0).toFixed(2)}`;
        }
        
        function formatStatus(status) {
            const labels = {
                not_called: 'Not Called',
                called: 'Called',
                answered: 'Answered',
                no_answer: 'No Answer',
                converted: 'Converted',
                not_interested: 'Not Interested'
            };
            return labels[status] || status;
        }
        
        function formatReason(reason) {
            const labels = {
                user_suppressed: 'Unsubscribed',
                hard_bounce: 'Hard Bounce',
                spam_complaint: 'Spam Complaint',
                invalid_email: 'Invalid Email',
                unsubscribed: 'Unsubscribed'
            };
            return labels[reason] || reason;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function timeAgo(dateStr) {
            if (!dateStr) return '';
            const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }
        
        // Initialize
        loadData();
    </script>
</body>
</html>
