<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noriks Call Center</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Country Header Bar */
        .country-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .country-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0;
        }
        .country-btn {
            padding: 20px 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            color: rgba(255,255,255,0.7);
        }
        .country-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .country-btn.active {
            background: rgba(255,255,255,0.15);
            border-bottom-color: #3b82f6;
            color: white;
        }
        .country-btn .flag {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }
        .country-btn .name {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .country-btn .count {
            font-size: 18px;
            font-weight: 700;
            margin-top: 4px;
            color: #3b82f6;
        }
        .country-btn.active .count {
            color: #60a5fa;
        }
        
        /* Loading */
        .loading-bar {
            height: 3px;
            background: #1e293b;
            position: relative;
            overflow: hidden;
        }
        .loading-bar.active::after {
            content: '';
            position: absolute;
            left: -50%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: loading 1s infinite;
        }
        @keyframes loading {
            to { left: 100%; }
        }
        
        /* Adjust main content */
        .main-content {
            margin-left: 260px;
        }
        .page-content {
            padding: 24px;
        }
        
        @media (max-width: 1200px) {
            .country-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 768px) {
            .country-grid { grid-template-columns: repeat(4, 1fr); }
            .country-btn { padding: 12px 8px; }
            .country-btn .flag { font-size: 24px; }
            .country-btn .name { font-size: 10px; }
            .country-btn .count { font-size: 14px; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Loading Bar -->
    <div class="loading-bar" id="loadingBar"></div>

    <!-- Country Header -->
    <div class="country-header" id="countryHeader">
        <div class="country-grid" id="countryGrid">
            <button class="country-btn active" data-store="">
                <span class="flag">üåç</span>
                <span class="name">All</span>
                <span class="count" id="count-all">-</span>
            </button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">N</div>
            <span class="sidebar-title">Call Center</span>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="#" class="nav-item active" data-tab="abandoned">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Abandoned Carts</span>
                    <span class="nav-badge" id="abandoned-count">0</span>
                </a>
                <a href="#" class="nav-item" data-tab="suppressed">
                    <i class="fas fa-user-slash"></i>
                    <span>Suppressed Profiles</span>
                    <span class="nav-badge" id="suppressed-count">0</span>
                </a>
                <a href="#" class="nav-item" data-tab="pending">
                    <i class="fas fa-clock"></i>
                    <span>Pending Orders</span>
                    <span class="nav-badge" id="pending-count">0</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Reports</div>
                <a href="report.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistics</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-card">
                <div class="user-avatar" id="userAvatar">N</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Noriks</div>
                    <div class="user-role" id="userRole">Admin</div>
                </div>
                <button onclick="logout()" style="background: none; border: none; color: var(--sidebar-text); cursor: pointer; padding: 8px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 style="font-size: 18px; font-weight: 600; margin: 0;">
                    <span id="currentCountryName">All Countries</span>
                </h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="globalSearch">
                </div>
                <button class="header-btn" onclick="loadData(true)" title="Refresh (clear cache)">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-content">
            <!-- Stats for selected country -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon blue"><i class="fas fa-shopping-cart"></i></div>
                    </div>
                    <div class="stat-value" id="statAbandoned">0</div>
                    <div class="stat-label">Abandoned Carts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon purple"><i class="fas fa-user-slash"></i></div>
                    </div>
                    <div class="stat-value" id="statSuppressed">0</div>
                    <div class="stat-label">Suppressed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
                    </div>
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">Pending Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon green"><i class="fas fa-euro-sign"></i></div>
                    </div>
                    <div class="stat-value" id="statValue">‚Ç¨0</div>
                    <div class="stat-label">Cart Value</div>
                </div>
            </div>
            
            <!-- Main Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-headset"></i> Call Queue</h2>
                </div>
                
                <div class="card-body">
                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" data-tab="abandoned">
                            <i class="fas fa-shopping-cart"></i> Abandoned
                            <span class="count" id="tab-abandoned-count">0</span>
                        </button>
                        <button class="tab" data-tab="suppressed">
                            <i class="fas fa-user-slash"></i> Suppressed
                            <span class="count" id="tab-suppressed-count">0</span>
                        </button>
                        <button class="tab" data-tab="pending">
                            <i class="fas fa-clock"></i> Pending
                            <span class="count" id="tab-pending-count">0</span>
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <select class="filter-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="not_called">Not Called</option>
                            <option value="called">Called</option>
                            <option value="answered">Answered</option>
                            <option value="no_answer">No Answer</option>
                            <option value="converted">Converted</option>
                            <option value="not_interested">Not Interested</option>
                        </select>
                        <input type="text" class="filter-input" id="filterSearch" placeholder="Search name, email, phone...">
                    </div>
                    
                    <!-- Tables -->
                    <div id="content-abandoned" class="tab-content active">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Store</th>
                                        <th>Value</th>
                                        <th>Items</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="abandoned-table"><tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="content-suppressed" class="tab-content" style="display:none;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Profile</th>
                                        <th>Phone</th>
                                        <th>Reason</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="suppressed-table"><tr><td colspan="7" style="text-align:center;padding:40px;">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="content-pending" class="tab-content" style="display:none;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Store</th>
                                        <th>Order</th>
                                        <th>Total</th>
                                        <th>Phone</th>
                                        <th>Order Status</th>
                                        <th>Call Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-table"><tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal -->
    <div class="modal-overlay" id="statusModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Update Call Status</h3>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="modalStatus">
                        <option value="not_called">Not Called</option>
                        <option value="called">Called</option>
                        <option value="answered">Answered</option>
                        <option value="no_answer">No Answer</option>
                        <option value="converted">Converted</option>
                        <option value="not_interested">Not Interested</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="modalNotes" placeholder="Notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveStatus()"><i class="fas fa-check"></i> Save</button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let abandonedCarts = [];
        let suppressedProfiles = [];
        let pendingOrders = [];
        let stores = [];
        let currentTab = 'abandoned';
        let currentStore = '';
        let currentEditId = null;
        
        // Auth check
        const user = JSON.parse(localStorage.getItem('callcenter_user') || 'null');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Admin' : 'Agent';
            document.getElementById('userAvatar').textContent = user.username[0].toUpperCase();
        }
        
        // Tab navigation
        document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(item.dataset.tab);
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
            });
        });
        
        document.querySelectorAll('.tab[data-tab]').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`content-${tab}`).style.display = 'block';
            applyFilters();
        }
        
        // Country selection
        document.getElementById('countryGrid').addEventListener('click', (e) => {
            const btn = e.target.closest('.country-btn');
            if (!btn) return;
            currentStore = btn.dataset.store || '';
            document.querySelectorAll('.country-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const store = stores.find(s => s.code === currentStore);
            document.getElementById('currentCountryName').textContent = store ? `${store.flag} ${store.name}` : 'All Countries';
            
            applyFilters();
            updateStats();
        });
        
        // Mobile sidebar
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        });
        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        });
        
        // Loading
        function setLoading(on) {
            document.getElementById('loadingBar').classList.toggle('active', on);
        }
        
        // Load data
        async function loadData(clearCache = false) {
            setLoading(true);
            
            if (clearCache) {
                await fetch('api.php?action=clear-cache').catch(() => {});
            }
            
            try {
                // Load stores first
                const storesRes = await fetch('api.php?action=stores');
                stores = await storesRes.json();
                renderCountryTabs();
                
                // Load all data in parallel
                const [cartsRes, profilesRes, ordersRes] = await Promise.all([
                    fetch('api.php?action=abandoned-carts'),
                    fetch('api.php?action=suppressed-profiles'),
                    fetch('api.php?action=pending-orders')
                ]);
                
                abandonedCarts = await cartsRes.json() || [];
                suppressedProfiles = await profilesRes.json() || [];
                pendingOrders = await ordersRes.json() || [];
                
                if (!Array.isArray(abandonedCarts)) abandonedCarts = [];
                if (!Array.isArray(suppressedProfiles)) suppressedProfiles = [];
                if (!Array.isArray(pendingOrders)) pendingOrders = [];
                
                updateCounts();
                updateStats();
                applyFilters();
            } catch (e) {
                console.error('Load error:', e);
            }
            
            setLoading(false);
        }
        
        function renderCountryTabs() {
            const grid = document.getElementById('countryGrid');
            grid.innerHTML = `
                <button class="country-btn active" data-store="">
                    <span class="flag">üåç</span>
                    <span class="name">All</span>
                    <span class="count" id="count-all">-</span>
                </button>
            `;
            stores.forEach(s => {
                grid.innerHTML += `
                    <button class="country-btn" data-store="${s.code}">
                        <span class="flag">${s.flag}</span>
                        <span class="name">${s.name}</span>
                        <span class="count" id="count-${s.code}">-</span>
                    </button>
                `;
            });
        }
        
        function updateCounts() {
            // Update sidebar counts
            document.getElementById('abandoned-count').textContent = abandonedCarts.length;
            document.getElementById('suppressed-count').textContent = suppressedProfiles.length;
            document.getElementById('pending-count').textContent = pendingOrders.length;
            document.getElementById('tab-abandoned-count').textContent = abandonedCarts.length;
            document.getElementById('tab-suppressed-count').textContent = suppressedProfiles.length;
            document.getElementById('tab-pending-count').textContent = pendingOrders.length;
            
            // Update country counts
            const counts = { all: abandonedCarts.length };
            stores.forEach(s => counts[s.code] = 0);
            abandonedCarts.forEach(c => {
                if (counts[c.storeCode] !== undefined) counts[c.storeCode]++;
            });
            
            Object.keys(counts).forEach(code => {
                const el = document.getElementById(`count-${code}`);
                if (el) el.textContent = counts[code];
            });
        }
        
        function updateStats() {
            const data = currentStore 
                ? abandonedCarts.filter(c => c.storeCode === currentStore)
                : abandonedCarts;
            const pendingData = currentStore
                ? pendingOrders.filter(o => o.storeCode === currentStore)
                : pendingOrders;
            
            document.getElementById('statAbandoned').textContent = data.length;
            document.getElementById('statSuppressed').textContent = suppressedProfiles.length;
            document.getElementById('statPending').textContent = pendingData.length;
            
            const totalValue = data.reduce((sum, c) => sum + (c.cartValue || 0), 0);
            const currency = data[0]?.currency || 'EUR';
            const symbols = { EUR: '‚Ç¨', CZK: 'Kƒç', PLN: 'z≈Ç', HUF: 'Ft' };
            document.getElementById('statValue').textContent = `${symbols[currency] || '‚Ç¨'}${totalValue.toFixed(0)}`;
        }
        
        // Render functions
        function renderAbandonedCarts(items) {
            const tbody = document.getElementById('abandoned-table');
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#64748b;">No abandoned carts</td></tr>';
                return;
            }
            tbody.innerHTML = items.map(c => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(c.customerName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${esc(c.customerName)}</div>
                                <div class="customer-email">${esc(c.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="store-badge"><span class="store-flag">${c.storeFlag}</span> ${c.storeName}</span></td>
                    <td class="amount-cell">${formatCurrency(c.cartValue, c.currency)}</td>
                    <td>${(c.cartContents||[]).slice(0,2).map(i=>`<div style="font-size:12px;">${i.quantity}x ${esc((i.name||'').substring(0,25))}</div>`).join('')}</td>
                    <td>${c.phone ? `<a href="tel:${c.phone}" class="phone-link"><i class="fas fa-phone"></i> ${c.phone}</a>` : '‚Äî'}</td>
                    <td><span class="status-badge ${c.callStatus}">${formatStatus(c.callStatus)}</span></td>
                    <td><div style="font-size:12px;">${timeAgo(c.abandonedAt)}<br><span style="color:#64748b;">${formatDate(c.abandonedAt)}</span></div></td>
                    <td>
                        <div class="action-btns">
                            ${c.phone ? `<button class="action-btn call" onclick="makeCall('${c.phone}')"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${c.id}','${c.callStatus}','${esc(c.notes||'')}')"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderSuppressedProfiles(items) {
            const tbody = document.getElementById('suppressed-table');
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#64748b;">No profiles</td></tr>';
                return;
            }
            tbody.innerHTML = items.map(p => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(p.firstName+' '+p.lastName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${esc(p.firstName)} ${esc(p.lastName)}</div>
                                <div class="customer-email">${esc(p.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td>${p.phone ? `<a href="tel:${p.phone}" class="phone-link"><i class="fas fa-phone"></i> ${p.phone}</a>` : '‚Äî'}</td>
                    <td><span class="status-badge" style="background:#fef3c7;color:#92400e;">${formatReason(p.suppressionReason)}</span></td>
                    <td>${formatDate(p.suppressedAt)}</td>
                    <td><span class="status-badge ${p.callStatus}">${formatStatus(p.callStatus)}</span></td>
                    <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">${esc(p.notes||'')}</td>
                    <td>
                        <div class="action-btns">
                            ${p.phone ? `<button class="action-btn call" onclick="makeCall('${p.phone}')"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${p.id}','${p.callStatus}','${esc(p.notes||'')}')"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderPendingOrders(items) {
            const tbody = document.getElementById('pending-table');
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#64748b;">No pending orders</td></tr>';
                return;
            }
            tbody.innerHTML = items.map(o => `
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">${getInitials(o.customerName)}</div>
                            <div class="customer-info">
                                <div class="customer-name">${esc(o.customerName)}</div>
                                <div class="customer-email">${esc(o.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="store-badge"><span class="store-flag">${o.storeFlag}</span> ${o.storeName}</span></td>
                    <td><strong>#${o.orderId}</strong></td>
                    <td class="amount-cell">${formatCurrency(o.orderTotal, o.currency)}</td>
                    <td>${o.phone ? `<a href="tel:${o.phone}" class="phone-link"><i class="fas fa-phone"></i> ${o.phone}</a>` : '‚Äî'}</td>
                    <td><span class="status-badge" style="background:#fef3c7;color:#92400e;">${o.orderStatus}</span></td>
                    <td><span class="status-badge ${o.callStatus}">${formatStatus(o.callStatus)}</span></td>
                    <td>
                        <div class="action-btns">
                            ${o.phone ? `<button class="action-btn call" onclick="makeCall('${o.phone}')"><i class="fas fa-phone"></i></button>` : ''}
                            <button class="action-btn" onclick="openModal('${o.id}','${o.callStatus}','${esc(o.notes||'')}')"><i class="fas fa-edit"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Filters
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterSearch').addEventListener('input', applyFilters);
        document.getElementById('globalSearch').addEventListener('input', applyFilters);
        
        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const search = (document.getElementById('filterSearch').value || document.getElementById('globalSearch').value).toLowerCase();
            
            if (currentTab === 'abandoned') {
                let data = abandonedCarts;
                if (currentStore) data = data.filter(c => c.storeCode === currentStore);
                if (status) data = data.filter(c => c.callStatus === status);
                if (search) data = data.filter(c => 
                    (c.customerName||'').toLowerCase().includes(search) ||
                    (c.email||'').toLowerCase().includes(search) ||
                    (c.phone||'').includes(search)
                );
                renderAbandonedCarts(data);
            } else if (currentTab === 'suppressed') {
                let data = suppressedProfiles;
                if (status) data = data.filter(p => p.callStatus === status);
                if (search) data = data.filter(p => 
                    ((p.firstName||'')+' '+(p.lastName||'')).toLowerCase().includes(search) ||
                    (p.email||'').toLowerCase().includes(search) ||
                    (p.phone||'').includes(search)
                );
                renderSuppressedProfiles(data);
            } else {
                let data = pendingOrders;
                if (currentStore) data = data.filter(o => o.storeCode === currentStore);
                if (status) data = data.filter(o => o.callStatus === status);
                if (search) data = data.filter(o => 
                    (o.customerName||'').toLowerCase().includes(search) ||
                    (o.email||'').toLowerCase().includes(search) ||
                    (o.phone||'').includes(search) ||
                    String(o.orderId).includes(search)
                );
                renderPendingOrders(data);
            }
        }
        
        // Modal
        function openModal(id, status, notes) {
            currentEditId = id;
            document.getElementById('modalStatus').value = status || 'not_called';
            document.getElementById('modalNotes').value = notes || '';
            document.getElementById('statusModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('statusModal').classList.remove('active');
            currentEditId = null;
        }
        async function saveStatus() {
            if (!currentEditId) return;
            const status = document.getElementById('modalStatus').value;
            const notes = document.getElementById('modalNotes').value;
            try {
                await fetch('api.php?action=update-status', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({id:currentEditId, callStatus:status, notes})
                });
                [abandonedCarts, suppressedProfiles, pendingOrders].forEach(arr => {
                    const item = arr.find(i => i.id === currentEditId);
                    if (item) { item.callStatus = status; item.notes = notes; item.lastUpdated = new Date().toISOString(); }
                });
                applyFilters();
                closeModal();
            } catch(e) { alert('Error saving'); }
        }
        
        function makeCall(phone) { window.open('tel:'+phone, '_self'); }
        function logout() { localStorage.removeItem('callcenter_user'); window.location.href = 'login.html'; }
        
        // Helpers
        function getInitials(n) { return (n||'?').split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase(); }
        function esc(t) { const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
        function formatCurrency(a,c) { const s={EUR:'‚Ç¨',CZK:'Kƒç',PLN:'z≈Ç',HUF:'Ft'}; return `${s[c]||c} ${parseFloat(a||0).toFixed(2)}`; }
        function formatStatus(s) { return {not_called:'Not Called',called:'Called',answered:'Answered',no_answer:'No Answer',converted:'Converted',not_interested:'Not Interested'}[s]||s; }
        function formatReason(r) { return {user_suppressed:'Unsubscribed',hard_bounce:'Bounce',spam_complaint:'Spam',invalid_email:'Invalid',unsubscribed:'Unsubscribed'}[r]||r; }
        function formatDate(d) { if(!d)return''; return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
        function timeAgo(d) { if(!d)return''; const s=Math.floor((new Date()-new Date(d))/1000); if(s<60)return'now'; if(s<3600)return Math.floor(s/60)+'m'; if(s<86400)return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; }
        
        // Init
        loadData();
    </script>
</body>
</html>
